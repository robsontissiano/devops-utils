# JSON Logs Pipeline

input {
  beats {
    port => 5044
    tags => ["json"]
  }

  tcp {
    port => 5001
    codec => json
    tags => ["json", "tcp"]
  }
}

filter {
  if "json" in [tags] {
    # Parse JSON message
    if [message] {
      json {
        source => "message"
        target => "parsed"
        remove_field => ["message"]
      }

      # Promote common fields to root level
      if [parsed][timestamp] {
        date {
          match => [ "[parsed][timestamp]", "ISO8601", "UNIX", "yyyy-MM-dd HH:mm:ss" ]
          target => "@timestamp"
        }
      }

      if [parsed][level] {
        mutate {
          add_field => { "log_level" => "%{[parsed][level]}" }
        }
      }

      if [parsed][message] {
        mutate {
          add_field => { "log_message" => "%{[parsed][message]}" }
        }
      }

      if [parsed][logger] {
        mutate {
          add_field => { "logger_name" => "%{[parsed][logger]}" }
        }
      }
    }

    # Add application name if present
    if [parsed][app] {
      mutate {
        add_field => { "application" => "%{[parsed][app]}" }
      }
    }

    # Tag errors
    if [log_level] =~ /(?i)error|fatal|critical/ {
      mutate {
        add_tag => ["error"]
      }
    }

    # Tag warnings
    if [log_level] =~ /(?i)warn/ {
      mutate {
        add_tag => ["warning"]
      }
    }
  }
}

output {
  if "json" in [tags] {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
      index => "app-logs-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
}

