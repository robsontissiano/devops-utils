# Apache Access Log Pipeline

input {
  beats {
    port => 5044
    tags => ["apache"]
  }
}

filter {
  if "apache" in [tags] {
    # Parse Apache combined log format
    grok {
      match => {
        "message" => "%{COMBINEDAPACHELOG}"
      }
      remove_field => "message"
    }

    # Parse timestamp
    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
      target => "@timestamp"
      remove_field => "timestamp"
    }

    # GeoIP lookup
    if [clientip] and [clientip] !~ /^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.)/ {
      geoip {
        source => "clientip"
        target => "geoip"
      }
    }

    # Parse user agent
    if [agent] {
      useragent {
        source => "agent"
        target => "ua"
      }
    }

    # Convert response code to integer
    if [response] {
      mutate {
        convert => { "response" => "integer" }
      }
    }

    # Convert bytes to integer
    if [bytes] {
      mutate {
        convert => { "bytes" => "integer" }
      }
    }

    # Add response category
    if [response] {
      if [response] >= 500 {
        mutate { add_field => { "response_category" => "5xx Server Error" } }
      } else if [response] >= 400 {
        mutate { add_field => { "response_category" => "4xx Client Error" } }
      } else if [response] >= 300 {
        mutate { add_field => { "response_category" => "3xx Redirection" } }
      } else if [response] >= 200 {
        mutate { add_field => { "response_category" => "2xx Success" } }
      }
    }
  }
}

output {
  if "apache" in [tags] {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
      index => "apache-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
}

