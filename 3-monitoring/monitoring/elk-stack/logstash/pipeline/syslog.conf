# Syslog Pipeline

input {
  udp {
    port => 5514
    type => "syslog"
  }

  tcp {
    port => 5514
    type => "syslog"
  }

  beats {
    port => 5044
    tags => ["syslog"]
  }
}

filter {
  if [type] == "syslog" or "syslog" in [tags] {
    # Parse syslog format
    grok {
      match => {
        "message" => [
          # RFC3164 format
          "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}",
          # RFC5424 format
          "<%{NONNEGINT:syslog_pri}>%{NONNEGINT:syslog_version} %{TIMESTAMP_ISO8601:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{NOTSPACE:syslog_program} %{NOTSPACE:syslog_pid} %{NOTSPACE:syslog_msgid} %{GREEDYDATA:syslog_message}"
        ]
      }
      remove_field => "message"
    }

    # Parse timestamp
    date {
      match => [ "syslog_timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss", "ISO8601" ]
      target => "@timestamp"
      remove_field => "syslog_timestamp"
    }

    # Extract syslog priority (facility and severity)
    if [syslog_pri] {
      ruby {
        code => "
          pri = event.get('syslog_pri').to_i
          event.set('syslog_facility_code', pri >> 3)
          event.set('syslog_severity_code', pri & 7)
        "
      }

      # Map facility code to name
      translate {
        field => "syslog_facility_code"
        destination => "syslog_facility"
        dictionary => {
          "0"  => "kernel"
          "1"  => "user-level"
          "2"  => "mail"
          "3"  => "system"
          "4"  => "security/auth"
          "5"  => "syslogd"
          "6"  => "line printer"
          "7"  => "network news"
          "8"  => "uucp"
          "9"  => "clock"
          "10" => "security/auth"
          "11" => "ftp"
          "12" => "ntp"
          "13" => "log audit"
          "14" => "log alert"
          "15" => "clock"
          "16" => "local0"
          "17" => "local1"
          "18" => "local2"
          "19" => "local3"
          "20" => "local4"
          "21" => "local5"
          "22" => "local6"
          "23" => "local7"
        }
      }

      # Map severity code to name
      translate {
        field => "syslog_severity_code"
        destination => "syslog_severity"
        dictionary => {
          "0" => "emergency"
          "1" => "alert"
          "2" => "critical"
          "3" => "error"
          "4" => "warning"
          "5" => "notice"
          "6" => "informational"
          "7" => "debug"
        }
      }
    }

    # Add tags based on severity
    if [syslog_severity_code] {
      if [syslog_severity_code] <= 2 {
        mutate { add_tag => ["critical"] }
      } else if [syslog_severity_code] == 3 {
        mutate { add_tag => ["error"] }
      } else if [syslog_severity_code] == 4 {
        mutate { add_tag => ["warning"] }
      }
    }
  }
}

output {
  if [type] == "syslog" or "syslog" in [tags] {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
      index => "syslog-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
}

